{{#section 'css'}}

<style>
    .main-container {
        width: 1280px;
        margin: auto;
    }

    .article-container {
        width: 730px;
    }

    .sticky-control {
        position: sticky;
        top: 10px;
        align-self: flex-start;
    }

    .optgroup-header {
        font-weight: 500;
        font-size: medium;
    }

    .option {
        margin-left: 15px;
    }

    .file-preview-image {
        object-fit: cover !important;
        width: 100% !important;
        height: 100% !important;
    }
</style>
{{/section}}

{{#section 'js'}}
{{!-- Phần này để cho select được nhiều category một lúc --}}
<script>
    new TomSelect('#selectCat', {
        plugins: ['remove_button'],
    });
    new TomSelect('#selectTag', {
        plugins: ['remove_button'],
    });
</script>

{{!-- WYSIWYG --}}
<script>
    tinymce.init({
        selector: '#txtContent',
        height: 600,
        plugins: 'image link autolink lists table media',
        automatic_uploads: true,
        images_upload_url: '/writer/upload-image?id={{this.draft.id}}',
        menubar: false,
        toolbar: [
            'undo redo | bold italic underline strikethrough | numlist bullist | alignleft aligncenter alignright | forecolor backcolor | table link image media',
        ],
        toolbar_sticky: true,
        language: 'vi'
    });

    document.getElementById('articleForm').addEventListener('submit', function (e) {
        const content = tinymce.get('txtContent').getContent({ format: 'text' }).trim();
        if (!content) {
            alert('Vui lòng nhập nội dung bài viết!');
            e.preventDefault();
        }
    });
</script>

{{!-- file input --}}
<script>
    $('#fileThumbnail').fileinput({
        allowedFileExtensions: ['jpg', 'gif'],
        language: 'vi',
        dropZoneEnabled: false,
        showPreview: false,
        showUpload: false,
        showRemove: false,
    });

    $('#fileThumbnail').on('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();

            reader.onload = function (e) {
                // Set ảnh vào trong khung preview
                $('#preview-image').attr('src', e.target.result);
                $('#preview-container').show();  // Hiển thị khung preview
            };

            reader.readAsDataURL(file); // Đọc ảnh dưới dạng URL
        }
    });
</script>
{{/section}}

<div class="main-container d-flex mt-5 mb-5">
    <form id="articleForm" class="mx-auto" action="/writer/save-article?id={{this.draft.id}}" method="post"
        enctype="multipart/form-data">
        <div class="wrapper d-flex mx-auto">
            {{!-- Thanh điều khiển quay lại lưu xóa --}}
            <div class="sticky-control bg-light p-2 mr-3 rounded">
                <a href="/writer/manage-articles" type="button" class="btn btn-secondary mb-2">
                    <i class="bi bi-reply"></i>
                </a> <br>
                <a href="/writer/del-articles?id={{this.draft.id}}" type="button" class="btn btn-danger mb-2">
                    <i class="bi bi-trash3"></i>
                </a> <br>
                <button type="submit" class="btn btn-primary mb-2">
                    <i class="bi bi-floppy-fill"></i>
                </button> <br>
                <a href="/writer/submit-artcile?id={{this.draft.id}}" type="button" class="btn btn-success">
                    <i class="bi bi-file-earmark-arrow-up-fill"></i>
                </a>
            </div>

            {{!-- Nội dung chính --}}
            <div class="article-container mx-auto p-3 bg-light rounded">
                <h4 class="ml-4 mb-2" style="color: #6B6869; font-size: 18px"><b>Chỉnh sửa bài viết</b></h4>
                <hr class="mt-0">

                {{#if this.isPending}}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    Bài viết của bạn vẫn đang chờ được duyệt, bạn có thể chỉnh sửa nó bây giờ!
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                {{/if}}

                {{#if this.isRejected}}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    Bài viết của bạn không được duyệt, lí do là: <br>
                    <b>{{this.draft.reject_reason}}</b> <br>
                    <hr class="m-2">
                    Hãy chỉnh sửa trước khi đăng kiểm duyệt lại!
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                {{/if}}

                <div class="form-group">
                    <label class="ml-2" for="txtTitle">Tiêu đề</label>
                    <input type="text" name="title" id="txtTitle" class="form-control" placeholder="Nhập tiêu đề ở đây"
                        aria-describedby="helpId" value="{{this.draft.title}}" required>
                </div>
                <div class="form-group">
                    <label class="ml-2" for="txtAbstract">Tóm tắt bài viết</label>
                    <textarea name="abstract" class="form-control" id="txtAbstract"
                        placeholder="Nhập tóm tắt bài viết ở đây" rows="3" aria-describedby="helpId"
                        required>{{this.draft.abstract}}</textarea>
                    <small id="helpId" class="text-muted ml-1">Nội dung tóm tắt hấp dẫn sẽ thu hút người đọc
                        hơn.</small>
                </div>
                <div class="form-group">
                    <label class="ml-2" for="fileThumbnail">Ảnh đại diện bài viết</label>
                    <input type="file" name="thumbnail" id="fileThumbnail" class="file" aria-describedby="helpId"
                        required>
                    <small id="helpId" class="text-muted ml-1">Chọn hình ảnh đại diện phù hợp cho bài viết.</small>

                    <div id="preview-container" style="margin-top: 10px; display: none;">
                        <img id="preview-image" src="" alt="Preview"
                            style="max-width: 100%; height: auto; object-fit: cover;">
                    </div>
                </div>
                <hr class="mt-0 mb-2">

                <div class="form-group">
                    <label class="ml-2" for="selectCat">Danh mục</label>
                    <select class="" name="categories" id="selectCat" placeholder="Chọn danh sách danh mục phù hợp..."
                        autocomplete="off" multiple required>
                        {{#each this.cData}}
                        <optgroup class="p-5" label="{{name}}">
                            {{#each children}}
                            <option value="{{id}}" {{#if selected}}selected{{/if}}>{{name}}</option>
                            {{/each}}
                        </optgroup>
                        {{/each}}
                    </select>
                </div>
                <div class="form-group">
                    <label class="ml-2" for="selectTag">Nhãn</label>
                    <select class="" name="tags" id="selectTag" placeholder="Chọn danh sách nhãn phù hợp..."
                        autocomplete="off" multiple required>
                        {{#each this.tData}}
                        <option value="{{id}}" {{#if selected}}selected{{/if}}>{{name}}</option>
                        {{/each}}
                    </select>
                </div>
                <hr class="mb-2">

                <div class="form-group">
                    <label class="ml-2" for="txtContent">Nội dung bài viết</label>
                    <textarea name="content" id="txtContent"></textarea>
                </div>
            </div>
        </div>
    </form>
</div>